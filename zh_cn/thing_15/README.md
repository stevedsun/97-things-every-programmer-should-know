# 以理性编程

手动推理软件正确性的结果往往会得到一个比代码更长且更容易包含错误的形式证明。自动化工具是首选，但并非总是可行的。下面所述的是一种中间路径：半正式地推理正确性。

本方法的基本思路是将所有待考虑的代码划分为短的部分——从单行代码，如函数调用，到少于十行的代码块，并对它们的正确性进行讨论。这些论证只需要足够有力，以能够说服你的“扮演恶魔的拥护者”同行程序员为止。

应该选择一个部分，使得在每个端点处，程序的*状态*（即程序计数器和所有“活着”的对象的值）满足易于描述的属性，该部分的功能（状态转换）易于描述为单个任务——这将使推理更简单。这些端点属性概括了函数的*前置条件*和*后置条件*以及循环和类（对其实例而言）的*不变量*等概念。如果这些部分需要修改，则努力使它们相互独立，这将简化推理并是不可缺少的。

许多众所周知（尽管可能不太遵循）和被认为“好”的编码实践会使推理更容易。因此，仅仅因为打算推理代码，您就已经开始思考更好的样式和结构了。并且毫不奇怪地，大多数这些实践可以通过静态代码分析器来检查：

- 避免使用 goto 语句，因为它们会使远程部分高度相互依赖。
- 避免使用可修改的全局变量，因为它们会使使用它们的所有部分都相互依赖。
- 每个变量的作用域应该尽可能小。例如，可以在其第一次使用之前声明一个局部对象。
- 在相关情况下，使对象*不可变*。
- 通过使用水平和垂直间距使代码易于阅读。例如，对齐相关结构并使用空行分隔两个部分。
- 通过为对象、类型、函数等选择描述性（但相对较短）的名称来使代码自我说明。
- 如果需要嵌套部分，则将其作为一个函数。
- 使函数短小并专注于单个任务。旧的*24 行限制*仍然适用。尽管屏幕尺寸和分辨率已经改变，但自 20 世纪 60 年代以来，人类的认知并没有改变。
- 函数应该具有较少的参数（四个是好的上限）。这并不限制传递给函数的数据：将相关参数分组到单个对象中有益于*对象不变量*，并减少了推理的负担，例如它们的一致性和连贯性。
- 更普遍地说，每个代码单元，从一个块到一个库，都应该具有*窄接口*。减少通信可以减少所需的推理。这意味着返回内部状态的*getter*是一种负担——不要询问对象以获取信息以处理。相反，请求对象使用它已经拥有的信息来完成工作。换句话说，*封装*只与*窄接口*有关，而且仅与*窄接口*有关。
- 为了保持类*不变量*，应该避免使用*setter*，因为*setter*往往允许破坏对象状态的不变量。

作者 [Yechiel Kimchi](http://programmer.97things.oreilly.com/wiki/index.php/Yechiel_Kimchi)
